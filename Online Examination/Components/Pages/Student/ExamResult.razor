@page "/student/exam-result/{ResultId:int}"
@inject ExamService ExamService
@inject NavigationManager Navigation
@rendermode InteractiveServer

@using Online_Examination.Services
@using Online_Examination.Domain

<PageTitle>Exam Result | Examination Board</PageTitle>

<div class="container mt-5">
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading results...</span>
            </div>
            <p class="mt-3 text-muted">Loading your exam results...</p>
        </div>
    }
    else if (attempt == null)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">Result Not Found</h4>
                    <p>The exam result you're looking for does not exist.</p>
                    <a href="/user-dashboard" class="btn btn-primary mt-2">
                        <i class="bi bi-house"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Success Header -->
                <div class="card shadow-lg mb-4 border-0">
                    <div class="card-body text-center py-5 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-white" style="font-size: 5rem;"></i>
                        </div>
                        <h1 class="text-white mb-2">Exam Completed!</h1>
                        <p class="text-white opacity-75 mb-0">Your exam has been submitted successfully</p>
                    </div>
                </div>

                <!-- Exam Details -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Exam Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small">Exam Title</label>
                                <p class="fw-bold mb-0">@attempt.Exam?.Title</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small">Completed On</label>
                                <p class="fw-bold mb-0">@attempt.DateCreated.ToString("MMMM dd, yyyy hh:mm tt")</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Total Questions</label>
                                <p class="fw-bold mb-0">@totalQuestions</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Time Limit</label>
                                <p class="fw-bold mb-0">@attempt.Exam?.TimeLimitMinutes minutes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Score Card -->
                <div class="card shadow-lg mb-4 border-0">
                    <div class="card-body text-center py-5">
                        <h3 class="text-muted mb-4">Your Score</h3>
                        <div class="display-1 fw-bold mb-4 @GetScoreColorClass()">
                            @attempt.Score <span class="text-muted">/ @totalQuestions</span>
                        </div>
                        <div class="progress mb-4" style="height: 30px;">
                            <div class="progress-bar @GetProgressBarClass()" 
                                 role="progressbar" 
                                 style="width: @percentage%;" 
                                 aria-valuenow="@percentage" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <strong>@percentage%</strong>
                            </div>
                        </div>
                        <h4 class="mb-3">
                            <span class="badge @GetBadgeClass() fs-5 px-4 py-3">
                                @GetPerformanceText()
                            </span>
                        </h4>
                    </div>
                </div>

                <!-- Performance Breakdown -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Performance Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <h3 class="text-success mt-2 mb-1">@attempt.Score</h3>
                                    <p class="text-muted small mb-0">Correct Answers</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                                    <h3 class="text-danger mt-2 mb-1">@wrongAnswers</h3>
                                    <p class="text-muted small mb-0">Wrong Answers</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-primary bg-opacity-10 rounded">
                                    <i class="bi bi-percent text-primary" style="font-size: 2rem;"></i>
                                    <h3 class="text-primary mt-2 mb-1">@percentage%</h3>
                                    <p class="text-muted small mb-0">Accuracy</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow mb-4">
                    <div class="card-body text-center">
                        <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                            <button class="btn btn-primary btn-lg px-5" @onclick="GoToDashboard">
                                <i class="bi bi-house"></i> Back to Dashboard
                            </button>
                            <button class="btn btn-outline-secondary btn-lg px-5" @onclick="ViewHistory">
                                <i class="bi bi-clock-history"></i> View Exam History
                            </button>
                        </div>
                        <div class="mt-4">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Your result has been saved to your exam history
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int ResultId { get; set; }

    private Attempt? attempt;
    private bool isLoading = true;
    private int totalQuestions;
    private int wrongAnswers;
    private double percentage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            attempt = await ExamService.GetAttemptByIdAsync(ResultId);

            if (attempt != null && attempt.Exam != null)
            {
                totalQuestions = attempt.Exam.Questions?.Count ?? 0;
                wrongAnswers = totalQuestions - attempt.Score;
                percentage = totalQuestions > 0 ? Math.Round((double)attempt.Score / totalQuestions * 100, 2) : 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading exam result: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetScoreColorClass()
    {
        if (percentage >= 80) return "text-success";
        if (percentage >= 60) return "text-primary";
        if (percentage >= 40) return "text-warning";
        return "text-danger";
    }

    private string GetProgressBarClass()
    {
        if (percentage >= 80) return "bg-success";
        if (percentage >= 60) return "bg-primary";
        if (percentage >= 40) return "bg-warning";
        return "bg-danger";
    }

    private string GetBadgeClass()
    {
        if (percentage >= 80) return "bg-success";
        if (percentage >= 60) return "bg-primary";
        if (percentage >= 40) return "bg-warning";
        return "bg-danger";
    }

    private string GetPerformanceText()
    {
        if (percentage >= 90) return "Outstanding! ??";
        if (percentage >= 80) return "Excellent Work! ??";
        if (percentage >= 70) return "Great Job! ??";
        if (percentage >= 60) return "Good Effort! ??";
        if (percentage >= 50) return "Keep Practicing! ??";
        return "Need More Practice ??";
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/user-dashboard");
    }

    private void ViewHistory()
    {
        Navigation.NavigateTo("/exam-history");
    }
}
