@page "/reset-password"
@layout EmptyLayout
@inject NavigationManager Navigation
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Reset Password | Examination Board</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="/css/forgotstyle.css" />
</HeadContent>

<div class="forgot-page">
    <div class="forgot-box">
        <h1>Reset Password</h1>

        <p class="instruction">
            Enter your new password for <strong>@Email</strong>
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert-message @(isError ? "alert-error" : "alert-success")">
                @message
            </div>
        }

        <div class="form-content">
            <div class="form-group">
                <label>New Password</label>
                <input type="password"
                       placeholder="Enter new password"
                       @bind="newPassword"
                       @bind:event="oninput"
                       class="form-control"
                       disabled="@isProcessing" />
            </div>

            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password"
                       placeholder="Confirm new password"
                       @bind="confirmPassword"
                       @bind:event="oninput"
                       class="form-control"
                       disabled="@isProcessing" />
            </div>

            <button class="btn-primary full-width" @onclick="HandleResetPassword" disabled="@isProcessing">
                @(isProcessing ? "Resetting..." : "Reset Password")
            </button>
        </div>

        <p class="back">
            <a href="login">← Back to Login</a>
        </p>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private string? newPassword;
    private string? confirmPassword;
    private string? message;
    private bool isError = false;
    private bool isProcessing = false;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            message = "Invalid reset link. Please request a new password reset.";
            isError = true;
        }
    }

    private async Task HandleResetPassword()
    {
        message = null;
        isError = false;

        // 验证输入
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            message = "Please enter a new password.";
            isError = true;
            return;
        }

        if (newPassword != confirmPassword)
        {
            message = "Passwords do not match.";
            isError = true;
            return;
        }

        if (newPassword.Length < 6)
        {
            message = "Password must be at least 6 characters.";
            isError = true;
            return;
        }

        isProcessing = true;

        try
        {
            var response = await Http.PostAsJsonAsync("/api/auth/reset-password", new
            {
                Email = Email,
                Token = Token,
                NewPassword = newPassword
            });

            if (response.IsSuccessStatusCode)
            {
                message = "Password reset successful! Redirecting to login...";
                isError = false;

                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                message = $"Failed to reset password: {errorContent}";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }
}