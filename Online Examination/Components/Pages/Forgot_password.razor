@page "/forgot-password"
@layout EmptyLayout
@inject NavigationManager Navigation
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Forgot Password | Examination Board</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="/css/forgotstyle.css" />
</HeadContent>

<div class="forgot-page">
    <div class="forgot-box">
        <h1>Forgot Password</h1>

        <p class="instruction">
            Enter your registered email address.<br>
            We will send you a verification code.
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert-message @(isError ? "alert-error" : "alert-success")">
                @message
            </div>
        }

        <div class="form-content">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email"
                       placeholder="Enter your email"
                       @bind="emailAddress"
                       @bind:event="oninput"
                       class="form-control"
                       disabled="@isProcessing" />
            </div>

            <button class="btn-primary full-width" @onclick="SendResetToken" disabled="@isProcessing">
                @(isProcessing ? "Sending..." : "Send Reset Code")
            </button>
        </div>

        <p class="back">
            <a href="login">← Back to Login</a>
        </p>
    </div>
</div>

@code {
    private string? emailAddress;
    private string? message;
    private bool isError = false;
    private bool isProcessing = false;

    private async Task SendResetToken()
    {
        message = null;
        isError = false;

        if (string.IsNullOrWhiteSpace(emailAddress))
        {
            message = "Please enter a valid email address.";
            isError = true;
            return;
        }

        isProcessing = true;

        try
        {
            var response = await Http.PostAsJsonAsync("/api/auth/forgot-password", new { Email = emailAddress });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ForgotPasswordResponse>();

                message = "Reset code sent! Redirecting...";
                isError = false;

                // 等待 1 秒后跳转到重置密码页面，并传递 email 和 token
                await Task.Delay(1000);
                Navigation.NavigateTo($"/reset-password?email={Uri.EscapeDataString(emailAddress)}&token={Uri.EscapeDataString(result?.Token ?? "")}");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                message = $"Error: {errorContent}";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Failed to send reset code: {ex.Message}";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private class ForgotPasswordResponse
    {
        public string? Message { get; set; }
        public string? Email { get; set; }
        public string? Token { get; set; }
    }
}