@page "/take-exam"
@page "/take-exam/{ExamId:int}"
@inject StudentService StudentService
@inject UserSession UserSession
@inject NavigationManager Navigation
@rendermode InteractiveServer

<HeadContent>
    <link rel="stylesheet" href="/css/take-exam.css">
</HeadContent>

<PageTitle>Take Exam</PageTitle>

<div class="container mt-4">
    @if (!UserSession.IsLoggedIn)
    {
        <div class="alert alert-warning">
            Please <a href="/login">login</a> to take the exam.
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading exam...</span>
            </div>
            <p>Loading exam...</p>
        </div>
    }
    else if (exam == null)
    {
        <div class="alert alert-danger">
            Exam not found.
        </div>
    }
    else
    {
        <div class="exam-header mb-4">
            <h2>@exam.Title</h2>
            <p class="text-muted">@exam.Description</p>
            <div class="alert alert-info">
                <strong>Time Limit:</strong> @exam.TimeLimitMinutes minutes | 
                <strong>Total Questions:</strong> @exam.Questions.Count
            </div>
        </div>

        <form @onsubmit="SubmitExam">
            @foreach (var question in exam.Questions)
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Question @(exam.Questions.IndexOf(question) + 1)</h5>
                        
                        @* READING PASSAGE: Display if present (for Language/Comprehension questions) *@
                        @if (!string.IsNullOrEmpty(question.ReadingPassage))
                        {
                            <div class="reading-passage bg-light p-3 rounded mb-3">
                                <h6 class="text-primary mb-2"><i class="bi bi-book"></i> Reading Passage:</h6>
                                <div class="passage-text">@question.ReadingPassage</div>
                            </div>
                        }

                        @* IMAGE: Display if present (for Math/Science questions with diagrams) *@
                        @if (!string.IsNullOrEmpty(question.ImageUrl))
                        {
                            <div class="question-image mb-3 text-center">
                                <img src="@question.ImageUrl" alt="Question Diagram" class="img-fluid rounded shadow-sm" style="max-height: 400px;" />
                            </div>
                        }

                        @* QUESTION TEXT: Always displayed *@
                        <p class="question-text">@question.Text</p>

                        <div class="options mt-3">
                            <!-- Critical: Use unique name per question to prevent radio button conflicts -->
                            <div class="form-check mb-2">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="question_@question.Id" 
                                       id="q@(question.Id)_a" 
                                       value="A"
                                       @onchange="@(() => RecordAnswer(question.Id, "A"))">
                                <label class="form-check-label" for="q@(question.Id)_a">
                                    <strong>A.</strong> @question.OptionA
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="question_@question.Id" 
                                       id="q@(question.Id)_b" 
                                       value="B"
                                       @onchange="@(() => RecordAnswer(question.Id, "B"))">
                                <label class="form-check-label" for="q@(question.Id)_b">
                                    <strong>B.</strong> @question.OptionB
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="question_@question.Id" 
                                       id="q@(question.Id)_c" 
                                       value="C"
                                       @onchange="@(() => RecordAnswer(question.Id, "C"))">
                                <label class="form-check-label" for="q@(question.Id)_c">
                                    <strong>C.</strong> @question.OptionC
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" 
                                       type="radio" 
                                       name="question_@question.Id" 
                                       id="q@(question.Id)_d" 
                                       value="D"
                                       @onchange="@(() => RecordAnswer(question.Id, "D"))">
                                <label class="form-check-label" for="q@(question.Id)_d">
                                    <strong>D.</strong> @question.OptionD
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="text-center mb-5">
                <button type="submit" class="btn btn-success btn-lg" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Submitting...</span>
                    }
                    else
                    {
                        <span>Submit Exam</span>
                    }
                </button>
            </div>
        </form>
    }
</div>

@code {
    // Route parameter: Exam ID from URL
    [Parameter]
    public int ExamId { get; set; }

    // Exam object loaded from database
    private Exam? exam;

    // Dictionary to store student's answers: Key = QuestionId, Value = Selected Option (A/B/C/D)
    private Dictionary<int, string> studentAnswers = new Dictionary<int, string>();

    private bool isLoading = true;
    private bool isSubmitting = false;

    // Called when component is initialized
    protected override async Task OnInitializedAsync()
    {
        // Check if user is logged in
        if (!UserSession.IsLoggedIn)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        try
        {
            // Fetch exam with questions from database
            exam = await StudentService.GetExamByIdAsync(ExamId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading exam: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    // Record student's answer when radio button is selected
    private void RecordAnswer(int questionId, string selectedOption)
    {
        if (studentAnswers.ContainsKey(questionId))
        {
            studentAnswers[questionId] = selectedOption;
        }
        else
        {
            studentAnswers.Add(questionId, selectedOption);
        }
    }

    // Submit exam and navigate to results page
    private async Task SubmitExam()
    {
        if (exam == null) return;

        try
        {
            isSubmitting = true;

            // Call StudentService to auto-grade and save attempt
            var attempt = await StudentService.SubmitExamAsync(
                UserSession.CurrentUserId, 
                ExamId, 
                studentAnswers
            );

            // Navigate to result page with attempt ID
            Navigation.NavigateTo($"/result/{attempt.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error submitting exam: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
