@page "/Account/ResetPassword"
@layout EmptyLayout

@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Online_Examination.Domain

@inject UserManager<Online_ExaminationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Reset Password | Examination Board</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="/css/forgotstyle.css" />
</HeadContent>

<div class="forgot-page">
    <div class="forgot-box">
        <h1>Reset Password</h1>

        <p class="instruction">
            Enter your new password below.
        </p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <i class="bi bi-check-circle"></i> @successMessage
            </div>
        }

        @if (string.IsNullOrEmpty(Code) || string.IsNullOrEmpty(Email))
        {
            <div class="alert alert-danger" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <i class="bi bi-exclamation-triangle"></i> Invalid password reset link. Please request a new password reset.
            </div>
            <p class="back" style="margin-top: 20px; text-align: center;">
                <a href="/Account/ForgotPassword">Request Password Reset</a>
            </p>
        }
        else
        {
            <div class="form-content">
                <EditForm Model="Input" FormName="reset-password" OnValidSubmit="OnValidSubmitAsync" method="post">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Email Address</label>
                        <InputText @bind-Value="Input.Email"
                                   class="form-control"
                                   placeholder="Email"
                                   readonly
                                   disabled="@isProcessing" />
                        <ValidationMessage For="() => Input.Email" class="text-danger" style="font-size: 0.8rem;" />
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>New Password</label>
                        <InputText type="password"
                                   @bind-Value="Input.Password"
                                   class="form-control"
                                   placeholder="Enter new password"
                                   disabled="@isProcessing" />
                        <ValidationMessage For="() => Input.Password" class="text-danger" style="font-size: 0.8rem;" />
                        <small class="form-text text-muted">Password must be at least 4 characters.</small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Confirm Password</label>
                        <InputText type="password"
                                   @bind-Value="Input.ConfirmPassword"
                                   class="form-control"
                                   placeholder="Confirm new password"
                                   disabled="@isProcessing" />
                        <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" style="font-size: 0.8rem;" />
                    </div>

                    <input type="hidden" name="Input.Code" value="@Input.Code" />

                    <button type="submit" class="btn-primary full-width" style="margin-top: 20px;" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Resetting Password...</span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </button>
                </EditForm>
            </div>

            <p class="back" style="margin-top: 20px; text-align: center;">
                <a href="/Account/Login">← Back to Login</a>
            </p>
        }
    </div>
</div>

@code {
    private string? errorMessage;
    private string? successMessage;
    private bool isProcessing = false;

    [SupplyParameterFromQuery]
    public string? Code { get; set; }

    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override void OnInitialized()
    {
        System.Diagnostics.Debug.WriteLine("========================================");
        System.Diagnostics.Debug.WriteLine("[ResetPassword] Page Initialized");
        System.Diagnostics.Debug.WriteLine($"[ResetPassword] Code parameter: {Code}");
        System.Diagnostics.Debug.WriteLine($"[ResetPassword] Email parameter: {Email}");
        System.Diagnostics.Debug.WriteLine("========================================");

        // Pre-fill email and code from query parameters
        if (!string.IsNullOrEmpty(Email))
        {
            Input.Email = Uri.UnescapeDataString(Email);
        }
        if (!string.IsNullOrEmpty(Code))
        {
            Input.Code = Code;
        }
    }

    private async Task OnValidSubmitAsync()
    {
        isProcessing = true;
        errorMessage = null;
        successMessage = null;

        System.Diagnostics.Debug.WriteLine("========================================");
        System.Diagnostics.Debug.WriteLine("[ResetPassword] Starting password reset process...");
        System.Diagnostics.Debug.WriteLine($"[ResetPassword] Email: {Input.Email}");
        System.Diagnostics.Debug.WriteLine($"[ResetPassword] Code: {Input.Code?.Substring(0, Math.Min(20, Input.Code?.Length ?? 0))}...");
        System.Diagnostics.Debug.WriteLine("========================================");

        try
        {
            // Find user by email
            var user = await UserManager.FindByEmailAsync(Input.Email);
            
            if (user == null)
            {
                System.Diagnostics.Debug.WriteLine("[ResetPassword] ❌ User not found");
                errorMessage = "User not found.";
                isProcessing = false;
                return;
            }

            System.Diagnostics.Debug.WriteLine("[ResetPassword] ✅ User found");

            // Decode the reset token
            string decodedCode;
            try
            {
                decodedCode = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Input.Code));
                System.Diagnostics.Debug.WriteLine("[ResetPassword] ✅ Code decoded successfully");
            }
            catch
            {
                System.Diagnostics.Debug.WriteLine("[ResetPassword] ❌ Failed to decode code");
                errorMessage = "Invalid reset code. Please request a new password reset.";
                isProcessing = false;
                return;
            }

            // Reset the password
            System.Diagnostics.Debug.WriteLine("[ResetPassword] Calling ResetPasswordAsync...");
            var result = await UserManager.ResetPasswordAsync(user, decodedCode, Input.Password);

            if (result.Succeeded)
            {
                System.Diagnostics.Debug.WriteLine("[ResetPassword] ✅ Password reset successful!");
                successMessage = "Password reset successful! Redirecting to login...";
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/Account/Login?reset=success");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine($"[ResetPassword] ❌ Password reset failed: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                isProcessing = false;
            }
        }
        catch (NavigationException)
        {
            // This is expected - Blazor throws this to perform navigation
            // Let it propagate so the redirect can complete
            throw;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[ResetPassword] ❌ Exception: {ex.Message}");
            errorMessage = $"An error occurred: {ex.Message}";
            isProcessing = false;
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Email is required.")]
        [EmailAddress(ErrorMessage = "Invalid email address.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required.")]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} characters long.", MinimumLength = 4)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Required(ErrorMessage = "Please confirm your password.")]
        [DataType(DataType.Password)]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";

        public string Code { get; set; } = "";
    }
}
