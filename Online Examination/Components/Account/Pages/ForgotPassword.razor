@page "/Account/ForgotPassword"
@layout EmptyLayout

@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Online_Examination.Data

@inject UserManager<Online_ExaminationUser> UserManager
@inject NavigationManager NavigationManager


<PageTitle>Forgot Password | Examination Board</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="/css/forgotstyle.css" />
</HeadContent>

<div class="forgot-page">
    <div class="forgot-box">
        <h1>Forgot Password</h1>

        <p class="instruction">
            Enter your registered email address.<br>
            A verification code will be generated for your reset process.
        </p>

        @if (!string.IsNullOrEmpty(infoMessage))
        {
            <div class="alert-message @(isError ? "alert-error" : "alert-success")"
                 style="background-color: @(isError ? "#f8d7da" : "#d4edda");
                            color: @(isError ? "#721c24" : "#155724");
                            padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                @infoMessage
            </div>
        }

        <div class="form-content">
            <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label>Email Address</label>
                    <InputText @bind-Value="Input.Email"
                               class="form-control"
                               placeholder="Enter your email"
                               required
                               disabled="@isProcessing" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" style="font-size: 0.8rem;" />
                </div>

                <button type="submit" class="btn-primary full-width" style="margin-top: 20px;" disabled="@isProcessing">
                    @(isProcessing ? "Generating Code..." : "Send Reset Code")
                </button>
            </EditForm>
        </div>

        <p class="back" style="margin-top: 20px; text-align: center;">
            <a href="Account/Login">← Back to Login</a>
        </p>
    </div>
</div>

@code {
    private string? infoMessage;
    private bool isError = false;
    private bool isProcessing = false;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        isProcessing = true;
        infoMessage = null;
        isError = false;

        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null)
        {
            infoMessage = "If the email exists, a reset code has been prepared.";
            isProcessing = false;
            return;
        }

        try
        {

            var code = await UserManager.GeneratePasswordResetTokenAsync(user);


            var encodedCode = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

            infoMessage = "Reset code generated! Redirecting...";


            await Task.Delay(1000);


            NavigationManager.NavigateTo($"Account/ResetPassword?code={encodedCode}");
        }
        catch (Exception ex)
        {
            isError = true;
            infoMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}