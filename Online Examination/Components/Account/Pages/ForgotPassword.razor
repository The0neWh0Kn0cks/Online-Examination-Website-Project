@page "/Account/ForgotPassword"
@layout EmptyLayout

@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Online_Examination.Domain

@inject UserManager<Online_ExaminationUser> UserManager
@inject IEmailSender<Online_ExaminationUser> EmailSender
@inject NavigationManager NavigationManager

<PageTitle>Forgot Password | Examination Board</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="/css/forgotstyle.css" />
</HeadContent>

<div class="forgot-page">
    <div class="forgot-box">
        <h1>Forgot Password</h1>

        <p class="instruction">
            Enter your registered email address to reset your password.
        </p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
            </div>
        }

        @if (emailSent)
        {
            <div class="alert alert-success" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <i class="bi bi-check-circle"></i> ✅ Reset link sent! Please check your email.
            </div>
        }

        <div class="form-content">
            <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label>Email Address</label>
                    <InputText @bind-Value="Input.Email"
                               class="form-control"
                               placeholder="Enter your email"
                               required
                               disabled="@isProcessing" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" style="font-size: 0.8rem;" />
                </div>

                <button type="submit" class="btn-primary full-width" style="margin-top: 20px;" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Reset Password</span>
                    }
                </button>
            </EditForm>
        </div>

        <p class="back" style="margin-top: 20px; text-align: center;">
            <a href="Account/Login">← Back to Login</a>
        </p>
    </div>
</div>

@code {
    private string? errorMessage;
    private bool isProcessing = false;
    private bool emailSent = false;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        isProcessing = true;
        errorMessage = null;
        emailSent = false;

        try
        {
            // Find user by email
            var user = await UserManager.FindByEmailAsync(Input.Email);
            
            if (user == null)
            {
                // Security: Don't reveal if email exists or not
                // Show success message even if user doesn't exist
                emailSent = true;
                isProcessing = false;
                return;
            }

            // Generate password reset token
            var code = await UserManager.GeneratePasswordResetTokenAsync(user);

            // Encode the token for URL transmission
            var encodedCode = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

            // Build callback URL for email - Must point to /Account/ResetPassword
            var callbackUrl = NavigationManager.ToAbsoluteUri($"/Account/ResetPassword?code={encodedCode}&email={Uri.EscapeDataString(Input.Email)}").ToString();

            System.Diagnostics.Debug.WriteLine($"[ForgotPassword] Generated callback URL: {callbackUrl}");

            // Send email with reset link
            await EmailSender.SendPasswordResetLinkAsync(user, Input.Email, callbackUrl);

            // Show success message
            emailSent = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred while sending the reset email. Please try again later.";
            _logger?.LogError(ex, "Error sending password reset email to {Email}", Input.Email);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private ILogger<ForgotPassword>? _logger;

    protected override void OnInitialized()
    {
        // Optional: Inject logger if needed
        // _logger = LoggerFactory.CreateLogger<ForgotPassword>();
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Email is required.")]
        [EmailAddress(ErrorMessage = "Invalid email address.")]
        public string Email { get; set; } = "";
    }
}
